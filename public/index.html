<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="#3c3f46">
    <title>ARPADYNE</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <link rel="icon" href="computes.ico">
    <style>
    #myform{
      width: 100%;
      display: flex;
      flex-direction: row;
    }
    #myform input {
      flex-grow: 1;
    }
    html, body, iframe, div { height: 100%; margin:0;}
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand" href="/">ARPADYNE</a>
      <div class="navbar-collapse" id="navbarSupportedContent">
        <form id="myform" class="form-inline my-8 my-md-0">
          <input class="form-control mr-sm-2" type="search" placeholder="some-arpadyne-domain.a" aria-label="Search" id="search" autofocus>
          <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Go</button>
        </form>
      </div>
    </nav>
    <div class="embed-responsive embed-responsive-21by9" id="div-content">
      <iframe id="content" name="content" class="embed-responsive-item" src="/arpadyne.html" frameborder="0" width="100%" height="100%"></iframe>
    </div>
    <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
    <!-- <script src="https://unpkg.com/ipfs@0.27.5/dist/index.js"></script> -->
    <!-- <script src="https://unpkg.com/ipfs@0.27.3/dist/index.js"></script> -->
    <script src="https://unpkg.com/ipfs/dist/index.js"></script>
    <script type="text/javascript">
      function loadIframe(iframeName, url) {
        var $iframe = $("#" + iframeName)
        if ($iframe.length) {
          $iframe.attr("src", url)
          return false
        }
        return true
      }
      function go(domain) {
        if(domain == undefined){
          domain = $("#search").val()
        }
        // console.log($("#search").val());
        loadIframe("content", "/waiting.html")
        $.get("/ipts/" + domain, function(data) {
          console.log('data',data);
          $("#hash").text(data)
          if (data == 404){
            loadIframe("content", "/404.html")
          } else {
            loadIframe("content", "https://ipfs.io/ipfs/" + data)
          }
        })
      }
      $(function() {
        $("#myform").submit(function($event) {
          $event.preventDefault()
          go()
        })
        var path = window.location.pathname.substr(1)
        if (path){
          $("#search").val(path)
          go(path)
        }
      })

      // Create the IPFS node instance
      const repoPath = 'ipfs-' + Math.random()

      // Create an IPFS node
      const node = new Ipfs({
        "init": false,
        "start": false,
        "repo": repoPath,
        "Addresses": {
          "Swarm": [
            "/ip4/127.0.0.1/tcp/4001"
          ],
          "API": "/ip4/0.0.0.0/tcp/5001",
          "Gateway": "/ip4/127.0.0.1/tcp/8080"
        }
      })

      // Init the node
      node.init(handleInit)

      function handleInit (err) {
        if (err) {
          throw err
        }

        node.start(() => {
          console.log('status: ', node.isOnline() ? 'online' : 'offline')

          // node.block.get('QmTRWksKB11cvqr3yYPZ9UbQUyckFCxM5E2rMAeJEmhbhr', function (err, file) {
          //   if (err) {
          //     throw err
          //   }
          //   // console.log(JSON.stringify(file));
          //   console.log(file.data.toString('utf8'))
          // })


          node.files.get('QmTRWksKB11cvqr3yYPZ9UbQUyckFCxM5E2rMAeJEmhbhr', function (err, files) {
            console.log("error", err);
            files.forEach((file) => {
              console.log(file.path)
              console.log(file.content.toString('utf8'))
              var $iframe = $("#content")
              $iframe.attr("srcdoc", file.content.toString('utf8'))
            })
          })


          // node.files.cat('QmTRWksKB11cvqr3yYPZ9UbQUyckFCxM5E2rMAeJEmhbhr/index.html', function (err, files) {
          //   files.forEach((file) => {
          //     console.log(file.path)
          //     console.log(file.content.toString('utf8'))
          //     var $iframe = $("#content")
          //     $iframe.attr("srcdoc", file.content.toString('utf8'))
          //   })
          // })


          // const stream = node.files.getReadableStream('QmTRWksKB11cvqr3yYPZ9UbQUyckFCxM5E2rMAeJEmhbhr/index.html')
          //
          // stream.on('data', (file) => {
          //   // write the file's path and contents to standard out
          //   console.log(file.path)
          //   console.log(file.path.toString())
          //   var $iframe = $("#content")
          //   $iframe.attr("srcdoc", file.content.toString('utf8'))
          // })

 

          // const validCID = 'QmTRWksKB11cvqr3yYPZ9UbQUyckFCxM5E2rMAeJEmhbhr'
          //
          // const stream = no de.files.getReadableStream(validCID)
          //
          // pull(
          //   stream,
          //   pull.collect((err, files) => {
          //     if (err) {
          //       throw err
          //     }
          //
          //     files.forEach((file) => {
          //       console.log(file.path)
          //       console.log(file.path.toString())
          //     })
          //   })
          // )


          // node.files.get('QmRi6mW7UJB1t7p99qRhFv4F93zVWPHKrZprxqVF9rJaVD/index.html', function (err, stream) {
          //       var res = ''
          //       console.log(stream[0].hash.toString());
          //       var $iframe = $("#content")
          //       $iframe.attr("srcdoc", stream[0].hash.toString())
          //
          //       // stream.on('data', function (chunk) {
          //       //   res += chunk.toString()
          //       // })
          //       //
          //       // stream.on('error', function (err) {
          //       //   console.error('Error - ipfs files cat ', err)
          //       // })
          //       //
          //       // stream.on('end', function () {
          //       //   console.log('Got:', res)
          //       //   // $("#div-content").html(res)
          //       //
          //       //   var $iframe = $("#content")
          //       //   if ($iframe.length) {
          //       //     $iframe.attr("srcdoc", res)
          //       //   }
          //       //
          //       // })
          //     })

        })
      }
    </script>
  </body>
</html>
